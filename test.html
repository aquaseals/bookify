<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Frontend App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #191414;
            color: #1db954;
        }
        .container {
            background: #282828;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
        }
        button {
            background: #1db954;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #1ed760;
        }
        .user-info {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .hidden {
            display: none;
        }
        pre {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽµ Frontend-Only Spotify App</h1>
        
        <div id="login-section">
            <p>Connect your Spotify account to get started:</p>
            <button onclick="authorizeSpotify()">Connect to Spotify</button>
        </div>

        <div id="user-section" class="hidden">
            <h2>Welcome!</h2>
            <div id="user-info" class="user-info"></div>
            <button onclick="getCurrentTrack()">Get Current Track</button>
            <button onclick="getTopTracks()">Get Top Tracks</button>
            <button onclick="logout()">Logout</button>
            
            <div id="track-info"></div>
        </div>
    </div>

    <script>
        // Replace with your actual Spotify app credentials
        const CLIENT_ID = '2757b9bf2e4649e7903aaefbc856adca';
        const REDIRECT_URI = 'https://hayaPapAya.com/callback';
        const SCOPES = 'user-read-private user-read-email user-read-currently-playing user-top-read';

        // PKCE helper functions
        function generateCodeVerifier() {
            const array = new Uint32Array(56/2);
            window.crypto.getRandomValues(array);
            return Array.from(array, dec => ('0' + dec.toString(16)).substr(-2)).join('');
        }

        async function generateCodeChallenge(verifier) {
            const data = new TextEncoder().encode(verifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Authorization
        async function authorizeSpotify() {
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            localStorage.setItem('code_verifier', codeVerifier);
            
            const params = new URLSearchParams({
                response_type: 'code',
                client_id: CLIENT_ID,
                scope: SCOPES,
                redirect_uri: REDIRECT_URI,
                state: generateRandomString(16),
                code_challenge_method: 'S256',
                code_challenge: codeChallenge
            });
            
            window.location.href = 'https://accounts.spotify.com/authorize?' + params.toString();
        }

        // Token exchange
        async function exchangeCodeForToken(code) {
            const codeVerifier = localStorage.getItem('code_verifier');
            
            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: REDIRECT_URI,
                    client_id: CLIENT_ID,
                    code_verifier: codeVerifier
                })
            });

            const data = await response.json();
            
            if (data.access_token) {
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('refresh_token', data.refresh_token);
                localStorage.removeItem('code_verifier');
                
                showUserSection();
                getUserProfile();
            } else {
                console.error('Token exchange failed:', data);
            }
        }

        // API calls
        async function spotifyRequest(endpoint) {
            const token = localStorage.getItem('access_token');
            
            const response = await fetch(`https://api.spotify.com/v1${endpoint}`, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            
            if (response.status === 401) {
                // Token expired, need to re-authenticate
                logout();
                return null;
            }
            
            return response.json();
        }

        async function getUserProfile() {
            const profile = await spotifyRequest('/me');
            if (profile) {
                document.getElementById('user-info').innerHTML = `
                    <h3>Hello, ${profile.display_name}!</h3>
                    <p>Email: ${profile.email}</p>
                    <p>Followers: ${profile.followers.total}</p>
                    <p>Country: ${profile.country}</p>
                `;
            }
        }

        async function getCurrentTrack() {
            const track = await spotifyRequest('/me/player/currently-playing');
            const trackInfo = document.getElementById('track-info');
            
            if (track && track.item) {
                trackInfo.innerHTML = `
                    <div class="user-info">
                        <h3>Currently Playing:</h3>
                        <p><strong>${track.item.name}</strong> by ${track.item.artists[0].name}</p>
                        <p>Album: ${track.item.album.name}</p>
                    </div>
                `;
            } else {
                trackInfo.innerHTML = '<div class="user-info"><p>No track currently playing</p></div>';
            }
        }

        async function getTopTracks() {
            const data = await spotifyRequest('/me/top/tracks?limit=5');
            const trackInfo = document.getElementById('track-info');
            
            if (data && data.items) {
                let html = '<div class="user-info"><h3>Your Top Tracks:</h3><ol>';
                data.items.forEach(track => {
                    html += `<li><strong>${track.name}</strong> by ${track.artists[0].name}</li>`;
                });
                html += '</ol></div>';
                trackInfo.innerHTML = html;
            }
        }

        // UI functions
        function showUserSection() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('user-section').classList.remove('hidden');
        }

        function showLoginSection() {
            document.getElementById('user-section').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('code_verifier');
            showLoginSection();
            document.getElementById('track-info').innerHTML = '';
        }

        // Handle callback
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                console.error('Authorization failed:', error);
            } else if (code) {
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                exchangeCodeForToken(code);
            } else if (localStorage.getItem('access_token')) {
                // User already logged in
                showUserSection();
                getUserProfile();
            }
        });
    </script>
</body>
</html>